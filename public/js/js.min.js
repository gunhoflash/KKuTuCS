function initializeButton(){$("#make").on("submit",function(e){e.preventDefault(),sendMessage("MAKE",$(this).find("input[name=roomname]").val(),$(this).find("input[name=password]").val(),$(this).find("input[name=mode]:checked").val()),$(this).find("input:not([type=radio])").val(""),$("#createRoom").modal("hide")}),$("#btn_quit").on("click",function(){removeInterval(0),removeInterval(1),sendMessage("QUIT",null,null,null)}),$("#btn_ready").on("click",function(){var e=$("#btn_ready").attr("data-ready");e="1"==e?"0":"1",$("#btn_ready").attr("data-ready",e),sendMessage("READY",e,null,null)}),$("#btn_send").on("click",function(){""!=$("#wordInput").val().trim()&&sendMessage("SEND",$("#wordInput").val().substring(0,31),null,null),$("#wordInput").val("")}),$("#roomlistArea").on("click",".gameroom",function(){if(null!=$(this).attr("data-pw")){var e="";"1"==$(this).attr("data-pw")&&(e=prompt("비밀번호를 입력하세요","")),sendMessage("JOIN",$(this).attr("data-index"),e,null)}}),$("#wordInput").keypress(function(e){"13"==(e.keyCode?e.keyCode:e.which)&&(e.preventDefault(),$("#btn_send").click())}),$("#btn_expand").on("click",function(){var e;"1"==$("#chatArea").attr("data-expand")?(e="180",$("#chatArea").attr("data-expand","0")):(e="0",$("#chatArea").attr("data-expand","1")),$(this).find("svg").css("transform","rotate("+e+"deg)")})}$(document).ready(function(){initializeButton(),initializeSocketAndObject()});var ar_interval=[null,null];function removeInterval(e){null!=ar_interval[e]&&(clearInterval(ar_interval[e]),ar_interval[e]=null)}function showRoundTimer(e,t){e*=10,null!=t&&$("#round_timer").attr("aria-valuemax",t),removeInterval(0),ar_interval[0]=setInterval(function(){--e<0&&removeInterval(e=0),$("#round_timer").width(100*e/(10*$("#round_timer").attr("aria-valuemax"))+"%")},100)}function showTurnTimer(e){var t=e*=10;removeInterval(1),ar_interval[1]=setInterval(function(){--t<0&&(t=0,removeInterval(1)),$("#turn_timer").width(100*t/e+"%")},100)}var socket,socketLink="ws://"+window.location.hostname+":7002",roomList=[],resultList=[],playerList=[],responseTime=0,uriQueries=[],audio=document.createElement("audio");function initializeSocketAndObject(){$("#btn_ready").removeClass("d-none"),$("*[data-ismain]").attr("data-ismain","true"),showWord(""),$("#chatArea").text("").trigger("create"),processROOMLIST(),socket=new WebSocket(socketLink),$("#Mainname").text("(Connecting..)"),socket.onopen=function(e){console.log("Socket opened.",e),$("#Mainname").text("KKuTuCS"),decodeURI(window.location.search).substr(1).split("&").forEach(function(e){var t=e.split("=");2==t.length&&(uriQueries[t[0]]=t[1])}),null!=uriQueries.nickname&&""!=uriQueries.nickname||(alert("Error: Nickname not found."),window.location.href="http://"+window.location.host),$("#title").text("KKuTuCS("+uriQueries.nickname+")"),sendMessage("ROOMLIST",uriQueries.nickname)},socket.onmessage=function(e){console.log("Socket received a message.",e.data),parseMessage(e.data)},socket.onclose=function(e){console.log("Socket closed.",e),initializeSocketAndObject()}}function sendMessage(e,t,a,s){if(t||(t=""),a||(a=""),s||(s=""),socket.readyState==socket.OPEN){var n="KKuTuCS\n"+e+"\n"+t+"\n"+a+"\n"+s;console.log(n),socket.send(n)}else alert("Cannot send!\nsocket.readyState: "+socket.readyState)}function parseMessage(e){var t=xssFilter(e).split("\n"),a=t[0],s=t[1],n=t[2],r=t[3];switch(a){case"SEND":showChat(s,n,!1);break;case"SYSTEMSEND":showChat(s,n,!0);break;case"WORD":processWORD(s,n,r);break;case"JOIN":processJOIN(s,n,r);break;case"DISCONNECTED":showChat(s,"is disconnected.",!0);break;case"CONNECTED":showChat(s,"is connected.",!0);break;case"ROOMLISTSTART":roomList=[];break;case"ROOMLISTMIDDLE":roomList.push(s);break;case"ROOMLISTEND":processROOMLIST();break;case"RESULTLISTSTART":resultList=[];break;case"RESULTLISTMIDDLE":resultList.push(s);break;case"RESULTLISTEND":processRESULT();break;case"PLAYERLISTSTART":playerList=[];break;case"PLAYERLISTMIDDLE":playerList.push(s);break;case"PLAYERLISTEND":processPLAYERLIST();break;case"NUMBEROFPEOPLE":$("#numberOfPeople").text(s+" 명이 메인에서 노닥거리는 중");break;case"TIMETEST":console.log("response time: "+((new Date).getTime()-responseTime)+"ms");break;case"ERROR":alert("[Server Error] "+s);break;case"CORRECT":removeInterval(0),removeInterval(1),showWord(s);break;case"PLAYBGM":processBGM(s,n,!0);break;case"GAMESTART":removeInterval(0),removeInterval(1),$("#btn_ready").addClass("d-none");break;case"ROUNDSTART":showRoundTimer(s,s),removeInterval(0);break;case"ROUNDOVER":removeInterval(0);break;case"TURNSTART":audio.pause(),showTurnTimer(s),showRoundTimer(n,null),processBGM("T",10*s,!0);break;case"QUITTED":showChat(s,"quitted.",!0);break;case"ANIMATION":processANIMATION(s,n);break;default:alert("[Unexpected Method Error] "+a)}}function showChat(e,t,a){null!=e&&null!=e||(e=""),null!=t&&null!=t||(t=""),0<e.length&&(e="<span class='text-primary'>["+e+"]</span>&nbsp;"),a||(e+=":&nbsp;"),$("#chatArea").append("<p class='mb-1"+(a?" text-muted":"")+"'>"+e+t+"</p>"),$("#chatArea").scrollTop($("#chatArea").prop("scrollHeight"))}function processWORD(e,t,a){switch(a){case"VALID":case"CHAIN":showChat(e,t,!1);break;case"DB":showChat(e,"<span class='text-danger'>"+t+"</span><span class='text-muted'>(없는 단어)</span>",!1);break;case"USED":showChat(e,"<span class='text-danger'>"+t+"</span><span class='text-muted'>(이미 쓰인 단어)</span>",!1);break;default:a==parseInt(a)&&showChat(e,"<span class='text-success'>"+t+"</span><span class='ml-1 text-muted'>+ "+a+"</span>",!1)}}function processJOIN(e,t,a){1==e?($("#Roomindex").text("#"+a),$("#Roomname").text(t),$("#btn_ready").removeClass("d-none").attr("data-ready","0"),$("*[data-ismain]").attr("data-ismain","false"),$("#chatArea").text("").trigger("create"),showChat(null,"Welcome to "+t+"!",!0)):alert("Cannot join!\n"+t)}function processROOMLIST(){var e,t,a="";for(t=0;t<roomList.length;t++)(e=roomList[t].split("`")).length<6||(a+="<div class='gameroom border shadow-hoverable-sm px-3 py-2 mb-2 text-truncate bg-white' data-index="+e[0]+" data-pw="+e[5]+"><span class='font-weight-bold'><span class='pr-1 text-primary'>#"+e[0]+"</span>"+e[1]+"</span><div class='d-flex small'><span class='text-muted'>"+("en"==e[2]?"En":"한")+"</span>"+("0"==e[3]?"<span class='text-success px-1'>Ready":"<span class='text-warning px-1'>Playing")+"</span><span class='text-black'>"+e[4]+"</span><span class='text-muted ml-auto'>"+("0"==e[5]?"":"PW")+"</span></div></div>");""==a&&(a="<p class='py-3 text-center text-muted'>No room</p>"),$("#roomlistArea").html(a).trigger("create")}function processRESULT(){$("#btn_ready").removeClass("d-none").attr("data-ready","0"),removeInterval(0),removeInterval(1),showChat(null,"Game over.",!0);var e,t,a,s="",n=[];for(a=0;a<resultList.length;a++)(e=resultList[a].split("`")).length<2||(n[a]=10*parseInt(e[1],10)+a);for(n=n.sort(function(e,t){return t<e?-1:t==e?0:1}),a=0;a<resultList.length;a++)t=n[a]%10,(e=resultList[t].split("`")).length<2||(s+=a+1+". "+e[0]+"'s score : "+e[1]+"<br>");$("#round_timer").css("width","0%"),$("#turn_timer").css("width","0%"),$("#resultScreen").modal("show"),$("#resultScreenBody").html(s).trigger("create"),playerList=resultList,processPLAYERLIST()}function processPLAYERLIST(){var e,t,a="";for(t=0;t<playerList.length;t++)(e=playerList[t].split("`")).length<3||(a+="<div class='gameroom d-flex border shadow-hoverable-sm px-3 py-2 mb-2 text-truncate"+("2"==e[2]?" bg-teal":"")+" bg-white'><img src='../public/img/kkutucs_char.png' class='mr-2 my-auto' style='height: 2.25rem;'><div><h6>"+e[0]+"</h6><div class='d-flex'>"+("0"==e[2]?"<span class='text-warning'>Not Ready":"<span class='text-success'>Ready")+"</span><span class='text-black px-1'>"+e[1]+"</span></div></div></div>");$("#roomlistArea").html(a).trigger("create")}function processBGM(e,t,a){var s=document.createElement("audio");0!=t&&(e+=t),s.src="public/media/"+e+".mp3",audio.pause(),"lobbyBGM"==e?(s.addEventListener("ended",function(){setTimeout(function(){audio.play()},500)},!1),audio=s):a&&(audio=s),s.play()}function processANIMATION(e,t){var a,s,n,r="",o=0,l=parseFloat(e,10);switch(l){case 2.1:n=.23;break;case 3.2:n=.36;break;case 5.1:n=.46;break;case 6.2:n=.57;break;case 8:n=.7;break;default:n=.23}s=1e3*n/t.length+10,a=setInterval(function(){showWord(r+=t[o]),processBGM("As",10*l,!1),++o==t.length&&(processBGM("K",10*l,!1),clearInterval(a))},s)}function showWord(e){var t;t=e.length<6?"2.50rem":e.length<12?"2.25rem":e.length<18?"2.00rem":e.length<24?"1.75rem":"1.50rem",$("#wordArea").css("font-size",t).text(e)}function xssFilter(e){return null==e||null==e?"":e.replace(/  /g,"&nbsp;&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&#39")}function TIMETEST(){sendMessage("TIMETEST",null,null,null),responseTime=(new Date).getTime()}